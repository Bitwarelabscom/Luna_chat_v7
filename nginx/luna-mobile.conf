# Luna Mobile - Local network only (10.0.0.x)
# Port 5555 - Mobile-optimized interface
#
# Installation:
#   sudo cp /opt/luna-chat/nginx/luna-mobile.conf /etc/nginx/sites-available/luna-mobile
#   sudo ln -s /etc/nginx/sites-available/luna-mobile /etc/nginx/sites-enabled/luna-mobile
#   sudo nginx -t && sudo systemctl reload nginx

server {
    listen 5555;
    listen [::]:5555;

    server_name _;

    # SECURITY: Only allow specific devices
    allow 10.0.0.10;   # phone
    allow 10.0.0.20;   # laptop
    allow 127.0.0.1;
    deny all;

    # Mobile Frontend - Next.js app
    location / {
        proxy_pass http://127.0.0.1:5556;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # API - Express backend (shared with main app)
    location /api/ {
        proxy_pass http://127.0.0.1:3005/api/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_buffering off;
        proxy_read_timeout 86400;
    }

    # WebSocket endpoints
    location /ws/ {
        proxy_pass http://127.0.0.1:3005/ws/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_buffering off;
        proxy_read_timeout 86400;
    }

    # Error pages
    error_page 403 /403.html;
    location = /403.html {
        internal;
        default_type text/html;
        return 403 '<html><body><h1>Access Denied</h1><p>This interface is only accessible from the local network (10.0.0.x).</p></body></html>';
    }
}
